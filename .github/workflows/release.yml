# Release Build Workflow - Uses reusable build template
name: Release Build
permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      release_notes:
        description: 'Release notes (optional)'
        required: false
        default: ''

jobs:
  get-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          VERSION=$(cat desktop-app/version.txt | tr -d '[:space:]')
          VERSION="v${VERSION}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

  build-macos:
    name: Build macOS (Apple Silicon)
    needs: get-version
    uses: ./.github/workflows/build-app.yml
    with:
      platform: darwin/arm64
      retention-days: 90

  publish-release:
    needs: [get-version, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifact structure
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.get-version.outputs.version }}
          name: Memoria ${{ needs.get-version.outputs.version }}
          body: |
            # Memoria - Personal AI Assistant

            Version: ${{ needs.get-version.outputs.version }}

            ## What's New
            ${{ github.event.inputs.release_notes }}

            ## Downloads
            - **macOS (Apple Silicon)**: memoria-darwin-arm64.tar.gz

            ## Installation
            1. Download the appropriate file for your platform
            2. Extract the archive
            3. Run the executable

            **Note**: This is a local-only AI assistant. All your data stays on your device.
          files: |
            artifacts/memoria-darwin-arm64/memoria-darwin-arm64.tar.gz
          draft: false
          prerelease: ${{ contains(needs.get-version.outputs.version, 'dev') || contains(needs.get-version.outputs.version, 'alpha') || contains(needs.get-version.outputs.version, 'beta') }}
